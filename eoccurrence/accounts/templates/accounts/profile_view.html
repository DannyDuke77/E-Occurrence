{% extends "core/base.html" %}

{% block title %}Profile - {{ profile.user.get_full_name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-xl mt-8 border border-gray-200">
    <!-- Header -->
    <div class="flex items-center space-x-6 mb-6">
        {% if profile.profile_picture %}
            <img src="{{ profile.profile_picture.url }}" alt="Profile picture"
                 class="w-32 h-32 rounded-full object-cover border-4 border-blue-500 shadow-md">
        {% else %}
            <div class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center border-4 border-gray-300 shadow-md">
                <span class="text-gray-500 text-lg font-semibold">No Image</span>
            </div>
        {% endif %}

        <div>
            <h1 class="text-3xl font-extrabold text-gray-800">
                {{ profile.user.get_full_name }}
            </h1>
            <p class="text-gray-500">@{{ profile.user.username }}</p>
            <p class="mt-1 text-sm text-gray-600">Joined: {{ profile.date_joined|date:"F j, Y" }}</p>
        </div>
    </div>

    <!-- Info Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="space-y-2">
            <p><strong>Email:</strong> {{ profile.user.email }}</p>
            <p><strong>Phone:</strong> {{ profile.phone_number|default:"Not provided" }}</p>
            <p><strong>ID Number:</strong> {{ profile.id_number|default:"Not provided" }}</p>
            <p><strong>Date of Birth:</strong> {{ profile.date_of_birth|date:"F j, Y"|default:"Not provided" }}</p>
            <p><strong>Address:</strong> {{ profile.address|default:"Not provided" }}</p>
        </div>

        <div class="space-y-2">
            <p><strong>User Role:</strong> 
                <span class="px-2 py-1 rounded-full text-white text-sm 
                    {% if profile.user_role == 'admin' %}bg-red-600
                    {% elif profile.user_role == 'police' %}bg-blue-600
                    {% elif profile.user_role == 'court' %}bg-yellow-600
                    {% else %}bg-gray-400{% endif %}">
                    {{ profile.get_user_role_display }}
                </span>
            </p>
            <p><strong>Department:</strong> {{ profile.department|default:"Not provided" }}</p>
            <p><strong>Account Status:</strong> 
                <span class="inline-block px-2 py-1 rounded-full text-sm font-semibold 
                    {% if profile.is_active %}bg-green-500 text-white
                    {% else %}bg-red-500 text-white{% endif %}">
                    {% if profile.is_active %}Active{% else %}Inactive{% endif %}
                </span>
            </p>
            <p><strong>Last Login:</strong> 
                {% if profile.last_activity %}
                    <span 
                        class="last-login-time text-gray-600"
                        data-timestamp="{{ profile.last_activity|date:'c' }}">
                    </span>
                {% else %}
                    <span class="text-gray-600">Never</span>
                {% endif %}


            </p>
        </div>
    </div>

    <!-- Action Button -->
    <div class="flex justify-start mt-4">
        <a href="{% url 'cases:search_cases' %}?recorded_by={{ profile.user.username }}"
           class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-transform transform hover:scale-105 hover:shadow-xl">
            Cases Recorded
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        const ONLINE_THRESHOLD_MIN = 10; // minutes to consider user online

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000); // minutes
            const diffHr = Math.floor(diffMin / 60);

            // âœ… Online if active in last 10 mins
            if (diffMin < ONLINE_THRESHOLD_MIN) {
                return "ðŸŸ¢ Online";
            }

            if (diffHr < 24) {
                // Less than 24 hours â†’ "X hrs Y mins ago"
                const hrs = diffHr;
                const mins = diffMin % 60;
                if (hrs > 0) return `${hrs} hr${hrs > 1 ? 's' : ''} ${mins} min${mins !== 1 ? 's' : ''} ago`;
                return `${mins} min${mins !== 1 ? 's' : ''} ago`;
            } else if (diffHr < 48) {
                // Yesterday â†’ "Yesterday at HH:MM"
                return `Yesterday at ${date.getHours().toString().padStart(2,"0")}:${date.getMinutes().toString().padStart(2,"0")}`;
            } else {
                // Older â†’ show date
                return date.toLocaleDateString() + ", " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        function updateLastLoginTimes() {
            document.querySelectorAll(".last-login-time").forEach(el => {
                const ts = el.dataset.timestamp;
                if (!ts) return;
                const date = new Date(ts);
                el.textContent = formatTimeAgo(date);
            });
        }

        // Run immediately and refresh every 1 minute
        updateLastLoginTimes();
        setInterval(updateLastLoginTimes, 60000);
    </script>

{% endblock %}
