{% extends "core/base.html" %}

{% block title %}Case {{ case.case_number }} Details{% endblock %}

{% block content %}
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-3 rounded-lg shadow-sm text-sm font-semibold
                    {% if message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                    {% elif message.tags == 'success' %}bg-green-100 text-green-900 border border-green-300
                    {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
    <!-- Header -->
        <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold">Case #{{ case.case_number }}</h2>
                <p class="text-sm opacity-90">{{ case.title }}</p>
            </div>

            <div>
                <p class="text-sm font-semibold text-gray-200">Recorded By: </p>
                <a href="{% url 'accounts:profile_view' case.recorded_by.profile.uuid %}"
                    class="text-sm font-semibold text-white hover:underline underline-offset-2"
                    title="{{ case.recorded_by.first_name }} {{ case.recorded_by.last_name }}">
                    {{ case.recorded_by.first_name }} {{ case.recorded_by.last_name }}
                </a>

            </div>
        </div>

    <!-- Details -->
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500">Complainant</p>
                    <a href="{% url 'cases:complainant_page' case.uuid case.complainant.uuid %}" class="text-lg hover:underline underline-offset-2 font-semibold text-blue-600 hover:text-blue-800">{{ case.complainant.first_name }} {% if case.complainant.last_name %}{{ case.complainant.last_name }}{% endif %}</a>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-500">Location</p>
                    <p class="text-lg">{{ case.location }}</p>
                </div>
            </div>

            <div>
                <p class="text-sm font-semibold text-gray-500">Description</p>
                <p class="leading-relaxed">{{ case.description }}</p>
            </div>

            <div class="grid grid-cols-2 :grid-cols-5 gap-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500">Incident Date</p>
                    <p>{{ case.incident_date|date:"F j, Y" }}</p>
                </div>
                
                <div>
                    <p class="text-sm font-semibold text-gray-500">Report Date</p>
                    <p>{{ case.report_date|date:"F j, Y" }}</p>
                </div>
                
                <div>
                    <p class="text-sm font-semibold text-gray-500">Case Status</p>
                   <span class="inline-block px-3 py-1 text-sm font-bold rounded-full text-white
                        {% if case.status == 'open' %}bg-blue-600
                        {% elif case.status == 'closed' %}bg-green-600
                        {% elif case.status == 'under_investigation' %}bg-yellow-500
                        {% elif case.status == 'in_court' %}bg-purple-600
                        {% elif case.status == 'dismissed' %}bg-gray-500
                        {% elif case.status == 'transferred' %}bg-teal-600
                        {% else %}bg-gray-400{% endif %}">
                        {{ case.status|title }}
                    </span>
                </div>

                {% if case.court_date %}
                    <div>
                        <p class="text-sm font-semibold text-gray-500">Court Date</p>
                        <p>{{ case.court_date|date:"F j, Y" }}</p>
                    </div>
                {% else %}
                    <div>
                        <p class="text-sm font-semibold text-gray-500">Court Date</p>
                        <p class="text-gray-500">Not Scheduled</p>
                    </div>
                {% endif %}

                <div>
                    <p class="text-sm font-semibold text-gray-500">Last Updated</p>
                    <p>{{ case.updated_at|date:"F j, Y, g:i a" }}</p>
                </div>
            </div>
        </div>

        <hr class="border-gray-500">

    <!-- Actions -->
        <div class="bg-gray-50 px-6 py-4">
            <h2 class="text-2xl font-bold mb-4 text-indigo-800">Actions</h2>
            <div class="flex flex-wrap gap-3 font-medium">
                <!-- Edit -->
                <a href="{% url 'cases:edit_case' case.uuid %}" 
                class="inline-flex items-center gap-2 px-5 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                Edit Case
                </a>

                <!-- Court Decision -->
                <a href="{% url 'cases:court_case_final' case.uuid %}" class="inline-flex items-center gap-2 px-5 py-2 bg-amber-500 text-white rounded-lg shadow hover:bg-amber-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971Zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 0 1-2.031.352 5.989 5.989 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971Z" />
                    </svg>
                Court Decision
                </a>

                <!-- Delete (admin only) -->
                {% if user.is_authenticated and user.profile.user_role == 'admin' %}
                    <a href="#" onclick="return confirm('Are you sure you want to delete this case? This action cannot be undone.');" 
                    class="inline-flex items-center gap-2 px-5 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    Delete Case
                    </a>
                {% endif %}
            </div>
        </div>

        <hr class="border-gray-500 my-6">

    <!-- Witnesses and Suspects Section -->
        <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Witnesses -->
            <div class="shadow-md rounded-lg overflow-hidden border border-gray-200">
                <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold">Witnesses</h2>
                        <p class="text-sm opacity-90">Total: {{ case.witnesses.count }}</p>
                    </div>
                    <a href="{% url 'cases:witness_entry' case.uuid %}" 
                    class="text-sm font-medium bg-white/20 px-3 py-1 rounded-lg hover:bg-white/30 transition">
                    + Add
                    </a>
                </div>
                <div class="bg-white p-4">
                    <ul class="divide-y divide-gray-200">
                        {% for witness in case.witnesses.all %}
                            <li class="py-2 flex items-start space-x-2">
                                <span class="text-gray-400 font-medium">{{ forloop.counter }}.</span>
                                <div class="flex flex-col">
                                    <a href="{% url 'cases:witness_page' case.uuid witness.uuid %}" 
                                    class="text-gray-800 hover:text-blue-600 hover:underline underline-offset-2 transition">
                                    {{ witness.name }}
                                    </a>
                                    <span class="text-gray-500 text-sm line-clamp-1">– {{ witness.statement }}</span>
                                </div>
                            </li>
                        {% empty %}
                            <li class="py-2 text-gray-500 italic">No witnesses added yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Suspects -->
            <div class="shadow-md rounded-lg overflow-hidden border border-gray-200">
                <div class="bg-red-600 text-white px-6 py-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold">Suspects</h2>
                        <p class="text-sm opacity-90">Total: {{ case.suspects.count }}</p>
                    </div>
                    <a href="{% url 'cases:suspect_entry' case.uuid %}" 
                    class="text-sm font-medium bg-white/20 px-3 py-1 rounded-lg hover:bg-white/30 transition">
                    + Add
                    </a>
                </div>
                <div class="bg-white p-4">
                    <ul class="divide-y divide-gray-200">
                        {% for suspect in case.suspects.all %}
                            <li class="py-2 flex items-start space-x-2">
                                <span class="text-gray-400 font-medium">{{ forloop.counter }}.</span>
                                <a href="{% url 'cases:suspect_page' case.uuid suspect.uuid %}" 
                                class="text-gray-800 hover:text-red-600 hover:underline underline-offset-2 transition">
                                {{ suspect.name }}
                                </a>
                                <span class="text-gray-500 text-sm truncate">– {{ suspect.contact_info|truncatechars:50 }}</span>
                            </li>
                        {% empty %}
                            <li class="py-2 text-gray-500 italic">No suspects added yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <hr class="border-gray-500 my-6">

        <!-- Court Decisions Section -->
        <div id="court-decisions" class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Court Decisions</h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                {% for decision in court_decisions %}
                    <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200 hover:shadow-lg transition">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">
                            Decision {{ forloop.counter }}
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">
                            {{ decision.decision_date|date:"M d, Y - h:i A" }}
                        </p>

                        <p class="text-sm font-medium text-gray-700 mb-2">
                            <span class="text-gray-500">Decision Type:</span> {{ decision.decision_type|title }}
                        </p>

                        <details class="group">
                            <summary class="flex items-center text-sm text-blue-600 cursor-pointer hover:underline underline-offset-2 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 group-open:rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                                <span class="group-open:hidden">View Decision</span>
                                <span class="hidden group-open:inline">Hide Decision</span>
                            </summary>
                            <div class="mt-3 pl-5 border-l-2 border-blue-100">
                                <p class="text-gray-600 text-sm leading-relaxed">{{ decision.decision_text }}</p>
                                <a href="{% url 'accounts:profile_view' decision.recorded_by.profile.uuid %}" 
                                class="block text-sm mt-3">
                                    <strong class="text-gray-600">Recorded By:</strong> 
                                    <span class="text-blue-600 hover:underline underline-offset-2">
                                        {{ decision.recorded_by.first_name }} {{ decision.recorded_by.last_name }}
                                    </span>
                                </a>
                            </div>
                        </details>
                    </div>
                {% empty %}
                    <div class="bg-white p-6 rounded-xl shadow-sm text-center border border-gray-200">
                        <p class="text-gray-500">No court decisions found.</p>
                    </div>
                {% endfor %}
            </div>

        </div>
    </div>
{% endblock %}

