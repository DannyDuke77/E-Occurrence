{% extends "core/base.html" %}

{% block title %}Case {{ case.case_number }} Details{% endblock %}

{% block content %}
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-3 rounded-lg shadow-sm text-sm font-semibold
                    {% if message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                    {% elif message.tags == 'success' %}bg-green-100 text-green-900 border border-green-300
                    {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if case.deleted %}
        <div class="p-3 mb-6 rounded-lg shadow-sm text-sm font-semibold bg-red-100 text-red-800 border border-red-300">This case was deleted by <a href="{% url 'accounts:profile_view' case.deleted_by.profile.uuid %}" class="font-medium text-red-600 hover:underline">{{ case.deleted_by.get_full_name }}</a> on {{ case.deleted_at|date:"M j, Y, g:i a" }}</div>
    {% endif %}

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
        <!-- Header -->
        <div class="bg-gray-800 text-white px-6 py-5 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold">Case #{{ case.case_number }}</h2>
                <p class="text-sm text-gray-300 mt-1">{{ case.title }}</p>
            </div>

            <div class="text-right">
                <p class="text-xs font-medium text-gray-400">Recorded By</p>
                <a href="{% url 'accounts:profile_view' case.recorded_by.profile.uuid %}"
                    class="text-sm font-medium text-white hover:underline"
                    title="{{ case.recorded_by.first_name }} {{ case.recorded_by.last_name }}">
                    {{ case.recorded_by.first_name }} {{ case.recorded_by.last_name }}
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-6">
            <!-- Case Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Complainant Info -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase mb-2">Complainant</h3>
                    <a href="{% url 'cases:complainant_page' case.uuid case.complainant.uuid %}" 
                       class="text-lg font-semibold text-gray-900 hover:text-blue-700 hover:underline">
                        {{ case.complainant.first_name }} {% if case.complainant.last_name %}{{ case.complainant.last_name }}{% endif %}
                    </a>
                </div>
                
                <!-- Location Info -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase mb-2">Location</h3>
                    <p class="text-lg font-medium text-gray-900">{{ case.location }}</p>
                </div>
                
                <!-- Status Info -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase mb-2">Case Status</h3>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if case.status == 'open' %}bg-blue-100 text-blue-800
                        {% elif case.status == 'closed' %}bg-green-100 text-green-800
                        {% elif case.status == 'under_investigation' %}bg-yellow-100 text-yellow-800
                        {% elif case.status == 'in_court' %}bg-purple-100 text-purple-800
                        {% elif case.status == 'dismissed' %}bg-gray-100 text-gray-800
                        {% elif case.status == 'transferred' %}bg-teal-100 text-teal-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ case.status|title }}
                    </span>
                </div>
            </div>

            <!-- Description -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-3 border-b pb-2">Case Description</h3>
                <p class="text-gray-700 leading-relaxed">{{ case.description }}</p>
            </div>

            <!-- Timeline Information -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-medium text-gray-500 uppercase">Incident Date</p>
                    <p class="text-sm font-medium">{{ case.incident_date|date:"M j, Y" }}</p>
                </div>
                
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-medium text-gray-500 uppercase">Report Date</p>
                    <p class="text-sm font-medium">{{ case.report_date|date:"M j, Y" }}</p>
                </div>
                
                {% if case.court_date %}
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-medium text-gray-500 uppercase">Court Date</p>
                    <p class="text-sm font-medium">{{ case.court_date|date:"M j, Y" }}</p>
                </div>
                {% else %}
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-medium text-gray-500 uppercase">Court Date</p>
                    <p class="text-sm font-medium text-gray-400">Not Scheduled</p>
                </div>
                {% endif %}
                
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <p class="text-xs font-medium text-gray-500 uppercase">Last Updated</p>
                    <p class="text-sm font-medium">{{ case.updated_at|date:"M j, Y, g:i a" }}</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Case Actions</h3>
                <div class="flex flex-wrap gap-3">
                    <!-- Edit -->
                    <a href="{% url 'cases:edit_case' case.uuid %}" 
                    class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-md text-sm font-medium hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    Edit Case
                    </a>

                    <!-- Court Decision -->
                    <a href="{% url 'cases:court_case_final' case.uuid %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-md text-sm font-medium hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971Zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 0 1-2.031.352 5.989 5.989 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971Z" />
                        </svg>
                    Court Decision
                    </a>

                    <!-- Delete (admin only) -->
                    {% if user.is_authenticated and user.profile.user_role == 'admin' and not case.deleted %}
                        <a href="{% url 'cases:delete_case' case.uuid %}" onclick="return confirm('Are you sure you want to delete this case? This action cannot be undone.');" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-red-700 text-white rounded-md text-sm font-medium hover:bg-red-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                        Delete Case
                        </a>
                    {% endif %}
                    <a href="{% url 'cases:case_pdf' case.uuid %}" target="_blank"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-md text-sm font-medium hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                        </svg>
                        Generate PDF
                    </a>
                </div>
            </div>

            <!-- Witnesses and Suspects Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Witnesses -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">Witnesses</h3>
                            <p class="text-xs text-gray-300">Total: {{ case.witnesses.count }}</p>
                        </div>
                        <a href="{% url 'cases:witness_entry' case.uuid %}" 
                        class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">
                        + Add Witness
                        </a>
                    </div>
                    <div class="bg-white divide-y divide-gray-200">
                        {% for witness in case.witnesses.all %}
                            <div class="p-4 hover:bg-gray-50 transition">
                                <div class="flex items-start">
                                    <span class="text-gray-500 font-medium mr-2">{{ forloop.counter }}.</span>
                                    <div class="flex-1">
                                        <a href="{% url 'cases:witness_page' case.uuid witness.uuid %}" 
                                        class="block font-medium text-gray-900 hover:text-blue-700 hover:underline mb-1">
                                        {{ witness.name }}
                                        </a>
                                        <p class="text-sm text-gray-600 line-clamp-1">{{ witness.statement }}</p>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="p-4 text-center text-gray-500 italic">
                                No witnesses added yet.
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Suspects -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">Suspects</h3>
                            <p class="text-xs text-gray-300">Total: {{ case.suspects.count }}</p>
                        </div>
                        <a href="{% url 'cases:suspect_entry' case.uuid %}" 
                        class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">
                        + Add Suspect
                        </a>
                    </div>
                    <div class="bg-white divide-y divide-gray-200">
                        {% for suspect in case.suspects.all %}
                            <div class="p-4 hover:bg-gray-50 transition">
                                <div class="flex items-start">
                                    <span class="text-gray-500 font-medium mr-2">{{ forloop.counter }}.</span>
                                    <div class="flex-1">
                                        <a href="{% url 'cases:suspect_page' case.uuid suspect.uuid %}" 
                                        class="block font-medium text-gray-900 hover:text-blue-700 hover:underline mb-1">
                                        {{ suspect.name }}
                                        </a>
                                        <p class="text-sm text-gray-600">{{ suspect.contact_info|truncatechars:50 }}</p>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="p-4 text-center text-gray-500 italic">
                                No suspects added yet.
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Court Decisions Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Court Decisions</h3>
                
                {% if court_decisions %}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {% for decision in court_decisions %}
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900">Decision {{ forloop.counter }}</h4>
                                <span class="text-xs text-gray-500">{{ decision.decision_date|date:"M d, Y - h:i A" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="text-xs font-medium text-gray-700 bg-gray-200 px-2 py-1 rounded">
                                    {{ decision.decision_type|title }}
                                </span>
                            </div>
                            
                            <details class="group">
                                <summary class="flex items-center text-sm text-blue-600 cursor-pointer hover:underline mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 group-open:rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                    <span class="group-open:hidden">View Decision Details</span>
                                    <span class="hidden group-open:inline">Hide Decision Details</span>
                                </summary>
                                <div class="mt-3 pl-5 border-l-2 border-gray-300">
                                    <p class="text-gray-700 text-sm leading-relaxed">{{ decision.decision_text }}</p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        Recorded by: 
                                        <a href="{% url 'accounts:profile_view' decision.recorded_by.profile.uuid %}" 
                                        class="text-blue-600 hover:underline">
                                            {{ decision.recorded_by.first_name }} {{ decision.recorded_by.last_name }}
                                        </a>
                                    </p>
                                </div>
                            </details>
                        </div>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                        <p class="text-gray-500">No court decisions recorded.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}